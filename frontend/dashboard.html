<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard - Fashion Hub</title>
    <meta name="description" content="Your dashboard ‚Äî manage posts and view activity on Fashion Hub.">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="/favicon.ico" />
</head>
<body>
    <a class="skip-link" href="#main">Skip to content</a>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-brand">
                <div class="logo">üé® Fashion Hub</div>
                <button id="nav-toggle" class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">‚ò∞</button>
            </div>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="posts.html">All Posts</a>
                <a href="dashboard.html" class="active">Dashboard</a>
                <a href="create-post.html" class="btn-primary">Create Post</a>
                <button onclick="logout()" class="btn-secondary">Logout</button>
            </div>
        </div>
    </nav>

    <main id="main" class="dashboard">
        <div class="welcome">
            <h1 id="welcome-title">Dashboard</h1>
            <p id="welcome-subtitle">Manage your content and track your activity</p>
        </div>

        <!-- Teacher Dashboard -->
        <div id="teacher-dashboard" class="dashboard-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="posts-count">0</span>
                    <span class="stat-label">Total Posts</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="blog-posts">0</span>
                    <span class="stat-label">Blog Posts</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="social-posts">0</span>
                    <span class="stat-label">Social Posts</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="total-views">0</span>
                    <span class="stat-label">Total Views</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="total-likes">0</span>
                    <span class="stat-label">Total Likes</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="engagement-rate">0%</span>
                    <span class="stat-label">Engagement Rate</span>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                <a href="create-post.html" class="btn btn-primary" id="create-blog-btn">üìù Create Blog Post</a>
                <a href="create-social-post.html" class="btn btn-accent">üí¨ Create Social Post</a>
            </div>

            <div class="posts-section">
                <h2>My Posts</h2>
                <div class="posts-grid" id="my-posts">
                    <div class="loading">Loading your posts...</div>
                </div>
            </div>
        </div>

        <!-- Student Dashboard -->
        <div id="student-dashboard" class="dashboard-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="read-posts">0</span>
                    <span class="stat-label">Posts Read</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="liked-posts">0</span>
                    <span class="stat-label">Liked Posts</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="saved-posts">0</span>
                    <span class="stat-label">Saved Posts</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="comments-made">0</span>
                    <span class="stat-label">Comments Made</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="learning-streak">0</span>
                    <span class="stat-label">Day Streak</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="engagement-level">-</span>
                    <span class="stat-label">Engagement Level</span>
                </div>
            </div>

            <!-- Weekly Activity -->
            <div class="stats-section" style="margin-bottom: 2rem;">
                <h3>This Week's Activity</h3>
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                    <div class="stat-card">
                        <span class="stat-number" id="weekly-activity">0</span>
                        <span class="stat-label">Total Actions</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="likes-this-week">0</span>
                        <span class="stat-label">Likes</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="saves-this-week">0</span>
                        <span class="stat-label">Saves</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="comments-this-week">0</span>
                        <span class="stat-label">Comments</span>
                    </div>
                </div>
            </div>

            <!-- Learning Progress -->
            <div class="stats-section" style="margin-bottom: 2rem;">
                <h3>Learning Progress</h3>
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="stat-card">
                        <span class="stat-number" id="categories-explored">0</span>
                        <span class="stat-label">Categories Explored</span>
                        <div style="margin-top: 0.5rem;">
                            <div style="background: var(--border); height: 6px; border-radius: 3px; overflow: hidden;">
                                <div id="exploration-progress-bar" style="background: var(--success); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                            </div>
                            <small style="color: var(--muted);" id="exploration-text">0/6 categories</small>
                        </div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="top-category">-</span>
                        <span class="stat-label">Favorite Category</span>
                    </div>
                </div>
            </div>

            <!-- Achievements -->
            <div class="stats-section" style="margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">Achievements</h3>
                    <span class="stat-label" id="achievements-progress">0/6 unlocked</span>
                </div>
                <div class="achievements-grid" id="achievements-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                    <div class="loading">Loading achievements...</div>
                </div>
            </div>

        <!-- In the Student Dashboard section -->
<div id="student-dashboard" class="dashboard-section">
    <div class="stats-grid">
        <!-- ... existing student stats ... -->
    </div>

    <!-- Add Create Post buttons for Students -->
    <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
        <a href="create-post.html" class="btn btn-primary">Create Blog Post</a>
        <a href="create-social-post.html" class="btn btn-accent">Create Social Post</a>
    </div>

    <!-- ... rest of student dashboard ... -->
</div>

            <!-- Recommended Posts -->
            <div class="posts-section">
                <h2>Recommended For You</h2>
                <div class="posts-grid" id="recommended-posts">
                    <div class="loading">Loading recommended posts...</div>
                </div>
            </div>
        </div>

        <div id="error-state" class="error-state" style="display: none;">
            <div class="error">
                <p>There was an error loading the dashboard. <a href="javascript:location.reload()">Try again</a></p>
            </div>
        </div>
    </main>

    <footer class="site-footer">
        <div class="container">
            <small>¬© Fashion Hub ‚Äî Learn & Teach Fashion</small>
            <nav class="footer-nav">
                <a href="index.html">Home</a>
                <a href="posts.html">All Posts</a>
                <a href="register.html">Register</a>
            </nav>
        </div>
    </footer>

    <script>
        class DashboardManager {
            constructor() {
                this.currentUser = null;
                this.init();
            }

            init() {
                this.checkAuth();
                this.setupEventListeners();
            }

            checkAuth() {
                const token = localStorage.getItem('token');
                const user = localStorage.getItem('user');

                if (!token || !user) {
                    window.location.href = 'login.html';
                    return false;
                }

                try {
                    this.currentUser = JSON.parse(user);
                    return true;
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    window.location.href = 'login.html';
                    return false;
                }
            }

            setupEventListeners() {
                // Teacher blog post button
                const createBlogBtn = document.getElementById('create-blog-btn');
                if (createBlogBtn) {
                    createBlogBtn.addEventListener('click', (e) => {
                        if (this.currentUser.role !== 'teacher') {
                            e.preventDefault();
                            alert('Only teachers can create blog posts');
                            window.location.href = 'dashboard.html';
                        }
                    });
                }

                // Navigation toggle
                const toggle = document.getElementById('nav-toggle');
                const navLinks = document.querySelector('.nav-links');
                if (toggle && navLinks) {
                    toggle.addEventListener('click', () => {
                        const open = navLinks.classList.toggle('open');
                        toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
                    });

                    document.addEventListener('click', (e) => {
                        if (!navLinks.classList.contains('open')) return;
                        if (e.target === toggle) return;
                        if (!navLinks.contains(e.target)) {
                            navLinks.classList.remove('open');
                            toggle.setAttribute('aria-expanded', 'false');
                        }
                    });
                }
            }

            async initializeDashboard() {
                if (!this.currentUser) return;

                document.getElementById('welcome-title').textContent = `Welcome, ${this.currentUser.username}!`;
                document.getElementById('welcome-subtitle').textContent = `You are logged in as a ${this.currentUser.role}`;

                if (this.currentUser.role === 'teacher') {
                    document.getElementById('teacher-dashboard').style.display = 'block';
                    document.getElementById('student-dashboard').style.display = 'none';
                    await this.loadTeacherDashboard();
                } else {
                    document.getElementById('teacher-dashboard').style.display = 'none';
                    document.getElementById('student-dashboard').style.display = 'block';
                    await this.loadStudentDashboard();
                }
            }

            async loadTeacherDashboard() {
                try {
                    const [stats, posts] = await Promise.all([
                        this.fetchTeacherStats(),
                        this.fetchMyPosts()
                    ]);

                    this.updateTeacherStats(stats);
                    this.renderTeacherPosts(posts);

                } catch (error) {
                    console.error('Error loading teacher dashboard:', error);
                    this.showError('my-posts', 'Failed to load dashboard data');
                }
            }

            async loadStudentDashboard() {
                try {
                    const [stats, posts, achievementsData] = await Promise.all([
                        this.fetchStudentStats(),
                        this.fetchAllPosts(),
                        this.fetchStudentAchievements()
                    ]);

                    this.updateStudentStats(stats);
                    this.renderStudentPosts(posts);
                    this.renderAchievements(achievementsData);

                } catch (error) {
                    console.error('Error loading student dashboard:', error);
                    this.showError('recommended-posts', 'Failed to load dashboard data');
                }
            }

            async fetchTeacherStats() {
                const token = localStorage.getItem('token');
                try {
                    const response = await fetch('/api/teacher-stats', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.stats || {};
                    }
                    throw new Error(`HTTP ${response.status}`);
                } catch (error) {
                    console.warn('Using mock teacher stats:', error);
                    return {
                        totalPosts: 3,
                        blogPosts: 2,
                        socialPosts: 1,
                        totalViews: 156,
                        totalLikes: 42,
                        engagementRate: 28
                    };
                }
            }

            async fetchStudentStats() {
                const token = localStorage.getItem('token');
                try {
                    const response = await fetch('/api/student-stats', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.stats || {};
                    }
                    throw new Error(`HTTP ${response.status}`);
                } catch (error) {
                    console.warn('Using mock student stats:', error);
                    return this.getMockStudentStats();
                }
            }

            getMockStudentStats() {
                return {
                    readPosts: 15,
                    likedPosts: 9,
                    savedPosts: 6,
                    commentsMade: 4,
                    learningStreak: 7,
                    topCategory: 'Fashion Trends',
                    weeklyActivity: 12,
                    likesThisWeek: 8,
                    savesThisWeek: 3,
                    commentsThisWeek: 1,
                    categoriesExplored: 4,
                    totalCategories: 6,
                    explorationProgress: 67,
                    engagementLevel: 'Active'
                };
            }

            async fetchStudentAchievements() {
                const token = localStorage.getItem('token');
                try {
                    const response = await fetch('/api/student-achievements', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data;
                    }
                    throw new Error(`HTTP ${response.status}`);
                } catch (error) {
                    console.warn('Using mock achievements:', error);
                    return this.getMockAchievements();
                }
            }

            getMockAchievements() {
                return {
                    achievements: [
                        {
                            id: 'first_like',
                            name: 'First Like',
                            description: 'Liked your first post',
                            unlocked: true,
                            icon: 'üëç',
                            date: new Date().toISOString()
                        },
                        {
                            id: 'first_save',
                            name: 'Bookmarker',
                            description: 'Saved your first post',
                            unlocked: true,
                            icon: 'üìö',
                            date: new Date().toISOString()
                        },
                        {
                            id: 'first_comment',
                            name: 'Conversation Starter',
                            description: 'Left your first comment',
                            unlocked: false,
                            icon: 'üí¨',
                            date: null
                        },
                        {
                            id: 'three_day_streak',
                            name: 'Learning Streak',
                            description: '3 consecutive days of activity',
                            unlocked: true,
                            icon: 'üî•',
                            date: new Date().toISOString()
                        },
                        {
                            id: 'category_explorer',
                            name: 'Category Explorer',
                            description: 'Explored multiple categories',
                            unlocked: true,
                            icon: 'üß≠',
                            date: new Date().toISOString()
                        },
                        {
                            id: 'active_learner',
                            name: 'Active Learner',
                            description: '10+ total engagements',
                            unlocked: false,
                            icon: '‚≠ê',
                            date: null
                        }
                    ],
                    unlockedCount: 4,
                    totalAchievements: 6,
                    progress: 67
                };
            }

            async fetchMyPosts() {
                const token = localStorage.getItem('token');
                try {
                    const response = await fetch('/api/my-posts', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.posts || [];
                    }
                    throw new Error(`HTTP ${response.status}`);
                } catch (error) {
                    console.warn('Using mock posts:', error);
                    return this.generateMockPosts(3, true);
                }
            }

            async fetchAllPosts() {
                const token = localStorage.getItem('token');
                try {
                    const response = await fetch('/api/posts');
                    if (response.ok) {
                        const data = await response.json();
                        const posts = data.posts || [];
                        
                        // Enhance posts with like status if user is logged in
                        if (token) {
                            for (let post of posts) {
                                try {
                                    const likeResponse = await fetch(`/api/posts/${post.id}/like-status`, {
                                        headers: { 'Authorization': `Bearer ${token}` }
                                    });
                                    if (likeResponse.ok) {
                                        const likeData = await likeResponse.json();
                                        post.user_liked = likeData.liked;
                                        post.like_count = likeData.likeCount;
                                    }
                                } catch (error) {
                                    console.warn('Could not fetch like status for post:', post.id);
                                }
                            }
                        }
                        
                        return posts;
                    }
                    throw new Error(`HTTP ${response.status}`);
                } catch (error) {
                    console.warn('Using mock posts:', error);
                    return this.generateMockPosts(6, false);
                }
            }

            generateMockPosts(count, isOwnPosts = false) {
                const categories = ['Fashion Design', 'Trends', 'Sustainability', 'History'];
                const mockPosts = [];
                
                for (let i = 1; i <= count; i++) {
                    mockPosts.push({
                        id: i,
                        title: `Sample ${isOwnPosts ? 'My' : ''} Post ${i}`,
                        content: `This is a sample post content about fashion and style. It demonstrates what a post would look like in the dashboard.`,
                        category_name: categories[Math.floor(Math.random() * categories.length)],
                        author_name: isOwnPosts ? this.currentUser.username : 'Fashion Expert',
                        created_at: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(),
                        image_url: i % 2 === 0 ? `https://picsum.photos/400/300?random=${i}` : null,
                        view_count: Math.floor(Math.random() * 100),
                        like_count: Math.floor(Math.random() * 20),
                        user_liked: Math.random() > 0.7
                    });
                }
                return mockPosts;
            }

            updateTeacherStats(stats) {
                document.getElementById('posts-count').textContent = stats.totalPosts || 0;
                document.getElementById('blog-posts').textContent = stats.blogPosts || 0;
                document.getElementById('social-posts').textContent = stats.socialPosts || 0;
                document.getElementById('total-views').textContent = stats.totalViews || 0;
                document.getElementById('total-likes').textContent = stats.totalLikes || 0;
                document.getElementById('engagement-rate').textContent = `${stats.engagementRate || 0}%`;
            }

            updateStudentStats(stats) {
                document.getElementById('read-posts').textContent = stats.readPosts || 0;
                document.getElementById('liked-posts').textContent = stats.likedPosts || 0;
                document.getElementById('saved-posts').textContent = stats.savedPosts || 0;
                document.getElementById('comments-made').textContent = stats.commentsMade || 0;
                document.getElementById('learning-streak').textContent = stats.learningStreak || 0;
                
                // Engagement level with badge
                const engagementLevel = document.getElementById('engagement-level');
                engagementLevel.textContent = stats.engagementLevel || 'Beginner';
                engagementLevel.className = 'stat-number';
                
                // Weekly activity
                document.getElementById('weekly-activity').textContent = stats.weeklyActivity || 0;
                document.getElementById('likes-this-week').textContent = stats.likesThisWeek || 0;
                document.getElementById('saves-this-week').textContent = stats.savesThisWeek || 0;
                document.getElementById('comments-this-week').textContent = stats.commentsThisWeek || 0;
                
                // Learning progress
                document.getElementById('categories-explored').textContent = stats.categoriesExplored || 0;
                document.getElementById('top-category').textContent = stats.topCategory || 'Exploring';
                
                const progressBar = document.getElementById('exploration-progress-bar');
                const progressText = document.getElementById('exploration-text');
                if (progressBar && progressText) {
                    const progress = stats.explorationProgress || 0;
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `${stats.categoriesExplored || 0}/${stats.totalCategories || 6} categories (${progress}%)`;
                }
            }

            renderTeacherPosts(posts) {
                const container = document.getElementById('my-posts');
                
                if (!posts || posts.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>You haven't created any posts yet.</p>
                            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                                <a href="create-post.html" class="btn btn-primary">Create Blog Post</a>
                                <a href="create-social-post.html" class="btn btn-accent">Create Social Post</a>
                            </div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = '';
                posts.forEach(post => {
                    const card = this.createPostCard(post, true);
                    container.appendChild(card);
                });
            }

            renderStudentPosts(posts) {
                const container = document.getElementById('recommended-posts');
                
                if (!posts || posts.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>No posts available yet. Check back later!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = '';
                posts.slice(0, 6).forEach(post => {
                    const card = this.createPostCard(post, false);
                    container.appendChild(card);
                });
            }

            createPostCard(post, showActions = false) {
                const card = document.createElement('div');
                card.className = 'post-card';
                card.setAttribute('data-post-id', post.id);
                
                const imageHTML = post.image_url ? `
                    <div class="post-image-container">
                        <img src="${post.image_url}" alt="${post.title}" class="post-image" loading="lazy">
                    </div>
                ` : '';

                const actionsHTML = showActions ? `
                    <div class="post-actions">
                        <button class="btn btn-primary btn-small" onclick="dashboard.editPost(${post.id})">Edit</button>
                        <button class="btn btn-danger btn-small" onclick="dashboard.deletePost(${post.id})">Delete</button>
                    </div>
                ` : '';

                // Like button and stats - only show for non-owned posts or if student
                const interactionsHTML = !showActions || this.currentUser.role === 'student' ? `
                    <div class="post-interactions">
                        <button class="like-btn ${post.user_liked ? 'liked' : ''}" 
                                onclick="dashboard.toggleLike(${post.id})"
                                data-post-id="${post.id}">
                            <span class="like-icon">${post.user_liked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                            <span class="like-count">${post.like_count || 0}</span>
                        </button>
                        <span class="view-count">üëÅÔ∏è ${post.view_count || 0}</span>
                        ${this.currentUser.role === 'student' ? `
                            <button class="save-btn" onclick="dashboard.toggleSave(${post.id})">
                                ${post.user_saved ? 'üìö' : 'üìñ'}
                            </button>
                        ` : ''}
                    </div>
                ` : '';

                card.innerHTML = `
                    ${imageHTML}
                    <div class="post-content">
                        <h3>${post.title || 'Untitled'}</h3>
                        <p>${(post.content || '').substring(0, 120)}...</p>
                        <div class="post-meta">
                            <span class="post-category">${post.category_name || 'General'}</span>
                            <span>‚Ä¢ ${showActions ? '' : 'By ' + (post.author_name || 'Unknown') + ' ‚Ä¢'} ${new Date(post.created_at).toLocaleDateString()}</span>
                        </div>
                        ${interactionsHTML}
                        ${actionsHTML}
                    </div>
                `;

                return card;
            }

            renderAchievements(achievementsData) {
                const container = document.getElementById('achievements-container');
                if (!container) return;

                const achievements = achievementsData.achievements || [];
                
                container.innerHTML = '';
                
                if (achievements.length === 0) {
                    container.innerHTML = '<div class="empty-state">No achievements available.</div>';
                    return;
                }

                // Update progress text
                const progressElement = document.getElementById('achievements-progress');
                if (progressElement) {
                    progressElement.textContent = `${achievementsData.unlockedCount || 0}/${achievementsData.totalAchievements || 0} unlocked`;
                }

                achievements.forEach(achievement => {
                    const achievementCard = this.createAchievementCard(achievement);
                    container.appendChild(achievementCard);
                });
            }

            createAchievementCard(achievement) {
                const card = document.createElement('div');
                card.className = `achievement-card ${achievement.unlocked ? 'unlocked' : 'locked'}`;
                
                card.innerHTML = `
                    <div class="achievement-icon">
                        ${achievement.icon || 'üèÜ'}
                    </div>
                    <div class="achievement-info">
                        <div class="achievement-name">${achievement.name}</div>
                        <div class="achievement-description">${achievement.description}</div>
                        ${achievement.unlocked && achievement.date ? `
                            <div class="achievement-date">Unlocked on ${new Date(achievement.date).toLocaleDateString()}</div>
                        ` : ''}
                    </div>
                `;
                
                return card;
            }

            showError(containerId, message) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `
                        <div class="error">
                            <p>${message}</p>
                            <a href="javascript:location.reload()" class="btn btn-secondary">Reload Page</a>
                        </div>
                    `;
                }
            }

            // Like functionality
            async toggleLike(postId) {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Please log in to like posts');
                        return;
                    }

                    const response = await fetch(`/api/posts/${postId}/like`, {
                        method: 'POST',
                        headers: { 
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        
                        // Update the like button UI
                        const likeBtn = document.querySelector(`.like-btn[data-post-id="${postId}"]`);
                        const likeIcon = likeBtn?.querySelector('.like-icon');
                        const likeCount = likeBtn?.querySelector('.like-count');
                        
                        if (likeBtn && likeIcon && likeCount) {
                            if (data.liked) {
                                likeBtn.classList.add('liked');
                                likeIcon.textContent = '‚ù§Ô∏è';
                                likeCount.textContent = parseInt(likeCount.textContent) + 1;
                            } else {
                                likeBtn.classList.remove('liked');
                                likeIcon.textContent = 'ü§ç';
                                likeCount.textContent = parseInt(likeCount.textContent) - 1;
                            }
                        }
                        
                        this.showSuccessMessage(data.message);
                        
                    } else {
                        throw new Error('Failed to toggle like');
                    }
                } catch (error) {
                    console.error('Toggle like error:', error);
                    alert('Error: Please log in to like posts');
                }
            }

            // Save functionality
            async toggleSave(postId) {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Please log in to save posts');
                        return;
                    }

                    const response = await fetch(`/api/posts/${postId}/save`, {
                        method: 'POST',
                        headers: { 
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        
                        // Update the save button UI
                        const saveBtn = document.querySelector(`.save-btn[onclick="dashboard.toggleSave(${postId})"]`);
                        if (saveBtn) {
                            saveBtn.textContent = data.saved ? 'üìö' : 'üìñ';
                        }
                        
                        this.showSuccessMessage(data.message);
                        
                    } else {
                        throw new Error('Failed to toggle save');
                    }
                } catch (error) {
                    console.error('Toggle save error:', error);
                    alert('Error saving post');
                }
            }

            showSuccessMessage(message) {
                // Create a temporary success message
                const successDiv = document.createElement('div');
                successDiv.className = 'success';
                successDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 1000;
                    padding: 1rem 1.5rem;
                    border-radius: var(--radius);
                    background: var(--success);
                    color: white;
                    box-shadow: var(--shadow-hover);
                `;
                successDiv.textContent = message;
                
                document.body.appendChild(successDiv);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 3000);
            }

            editPost(postId) {
                alert(`Edit functionality for post ${postId} would open an edit form. This feature is not yet implemented.`);
            }

            async deletePost(postId) {
                if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
                    return;
                }

                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`/api/posts/${postId}`, {
                        method: 'DELETE',
                        headers: { 
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        
                        // Remove post from UI with animation
                        const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                        if (postElement) {
                            postElement.style.opacity = '0.5';
                            postElement.style.transition = 'opacity 0.3s ease';
                            
                            setTimeout(() => {
                                postElement.remove();
                                this.showSuccessMessage('Post deleted successfully!');
                                
                                // Reload dashboard to update stats
                                if (this.currentUser.role === 'teacher') {
                                    setTimeout(() => this.loadTeacherDashboard(), 1000);
                                }
                            }, 300);
                        }
                        
                    } else {
                        throw new Error('Failed to delete post');
                    }
                } catch (error) {
                    console.error('Delete post error:', error);
                    alert(`Error: ${error.message}`);
                }
            }

            viewAchievements() {
                alert('Achievements gallery would open here. This feature is coming soon!');
            }
        }

        // Global functions
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        // Initialize dashboard when page loads
        let dashboard;
        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new DashboardManager();
            dashboard.initializeDashboard().catch(error => {
                console.error('Dashboard initialization failed:', error);
                document.getElementById('error-state').style.display = 'block';
            });
        });
    </script>
</body>
</html>